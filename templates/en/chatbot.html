<!-- templates/en/chatbot.html -->
{% extends "base.html" %}

{% block title %}Chat – AI Mimakun (English){% endblock %}

{% block content %}
  <div class="chat-container">
    <h1>AI Mimakun Chatbot</h1>

    <!-- メッセージ表示エリア -->
    <div id="message-area"></div>

    <!-- 入力エリア -->
    <div id="input-area" style="margin-top: 16px;">
      <input
        type="text"
        id="user-input"
        placeholder="Type your message..."
        style="width: 80%; padding: 8px; border-radius: 4px; border: 1px solid #ccc;"
      />
      <button
        id="send-button"
        style="padding: 8px 12px; border:none; border-radius:4px; background:#007bff; color:#fff; cursor:pointer;"
      >
        Send
      </button>
    </div>

    <!-- 音声再生用オーディオ要素 -->
    <audio id="bot-voice" style="display:none;"></audio>
  </div>
{% endblock %}


{% block scripts %}
<script>
  const sendButton = document.getElementById('send-button');
  const userInput   = document.getElementById('user-input');
  const messageArea = document.getElementById('message-area');
  const botVoice    = document.getElementById('bot-voice');

  // 画面にメッセージを追加する関数
  function appendMessage(text, isUser) {
    const div = document.createElement('div');
    div.classList.add(isUser ? 'user-message' : 'bot-message');
    div.textContent = text;
    messageArea.appendChild(div);
    messageArea.scrollTop = messageArea.scrollHeight;
  }

  // サーバーにメッセージを送信する関数
  async function sendMessage() {
    const content = userInput.value.trim();
    if (!content) return;
    appendMessage(content, true);
    userInput.value = '';

    try {
      // 英語用チャットAPI (app.py の chat_api_en に合わせる)
      const response = await fetch('{{ url_for("chat_api_en") }}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: content })
      });
      const data = await response.json();

      appendMessage(data.reply, false);
      if (data.voice_url) {
        botVoice.src = data.voice_url;
        botVoice.play();
      }
    } catch (err) {
      console.error('Chat error:', err);
      appendMessage('⚠️ Communication error occurred.', false);
    }
  }

  // イベントリスナー設定
  sendButton.addEventListener('click', sendMessage);
  userInput.addEventListener('keyup', e => {
    if (e.key === 'Enter') sendMessage();
  });
</script>
{% endblock %}
